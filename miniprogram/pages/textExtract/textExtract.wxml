<!-- miniprogram/pages/textExtract/textExtract.wxml -->
<view class="page-container">
  <t-dialog id="t-dialog" />

  <!-- TDesign导航栏 -->
  <t-navbar title="文案提取" left-arrow fixed bind:left-click="goBack" />

  <!-- 功能说明和用户状态 -->
  <view class="intro-card">
    <view class="intro-title">
      <t-icon name="file-text" size="32rpx" color="#1976d2" />
      <text>文案提取功能</text>
    </view>
    <view class="intro-desc">
      输入视频链接，快速提取视频原文案，支持一键复制到剪贴板。
    </view>
    
    <!-- 用户状态显示 -->
    <view class="user-status">
      <view class="status-item" wx:if="{{userStatus.isAnonymous}}">
        <t-icon name="user" size="24rpx" color="#ff9800" />
        <text>游客模式 · 今日剩余 {{userStatus.remainingFree}} 次免费使用</text>
      </view>
      <view class="status-item" wx:else>
        <t-icon name="wallet" size="24rpx" color="#4caf50" />
        <text>当前积分：{{userStatus.credits}}</text>
      </view>
    </view>
  </view>

  <!-- 输入区域 -->
  <view class="input-card">
    <t-input
      class="input-field"
      value="{{link}}"
      bind:change="onLinkInput"
      placeholder="请在此处粘贴视频分享链接"
      clearable
      prefix-icon="link"
    />
    <!-- 按钮组 -->
    <view class="button-group">
      <t-button
        class="action-btn"
        theme="{{isLoading ? 'default' : 'primary'}}"
        loading="{{isLoading}}"
        bind:tap="{{isLoading ? 'stopExtraction' : 'extractText'}}"
      >
        {{isLoading ? '取消提取' : '提取文案'}}
      </t-button>
      <t-button
        class="action-btn"
        theme="default"
        bind:tap="pasteFromClipboard"
        disabled="{{isLoading}}"
      >
        一键粘贴
      </t-button>
    </view>
  </view>

  <!-- 加载状态和进度 -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <t-loading text="{{loadingText}}" size="40rpx" />
    <view class="progress-info" wx:if="{{pollingCount > 0}}">
      <view class="progress-text">已尝试 {{pollingCount}}/{{maxPollingCount}} 次</view>
      <view class="progress-tip">文案提取可能需要较长时间，请耐心等待</view>
      <t-button 
        size="small" 
        theme="default" 
        variant="outline"
        bind:tap="stopExtraction"
        style="margin-top: 16rpx;"
      >
        取消提取
      </t-button>
    </view>
  </view>

  <!-- 文案结果弹窗 -->
  <t-popup 
    visible="{{showTextPopup}}" 
    bind:visible-change="onTextPopupVisibleChange"
    placement="bottom" 
    close-on-overlay-click="{{true}}"
    class="text-popup"
  >

    <view class="popup-content">
      <view class="text-result">
              <view class="action-buttons">
          <t-button theme="primary" block bind:tap="copyAllText">
            <t-icon name="file-copy" slot="icon"/>
            复制文案
          </t-button>

        </view>
        <view class="text-title" wx:if="{{textResult.title}}">
          <view class="content"> 标题：{{textResult.title}}</view>
        </view>
        
        <view class="text-content">
          <view class="content">{{textResult.content}}</view>
        </view>
        

      </view>
    </view>
  </t-popup>


</view>