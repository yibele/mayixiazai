# 修复UID问题指南

## 🐛 问题分析
用户得到了UID `297627`，这是容错机制产生的临时ID，说明：
1. `uid_counter` 集合为空或不存在
2. `getNextUID()` 函数执行失败，走了容错分支
3. 使用了 `Date.now() % 1000000` 作为临时UID

## 🔧 修复步骤

### 1. 在云开发控制台检查数据库
打开云开发控制台 > 数据库，检查：
- `uid_counter` 集合是否存在
- 如果存在，是否有 `user_counter` 文档
- 查看云函数日志确认错误原因

### 2. 清理错误数据（可选）
如果需要重置UID从1开始：
```javascript
// 删除现有用户（测试环境）
db.collection('users').where({
  uid: 297627
}).remove()

// 删除现有计数器
db.collection('uid_counter').doc('user_counter').remove()
```

### 3. 手动初始化计数器
在云开发控制台数据库中手动创建：

**集合名**: `uid_counter`
**文档ID**: `user_counter`
**数据**:
```json
{
  "count": 0,
  "createTime": "2024-01-01T00:00:00.000Z",
  "updateTime": "2024-01-01T00:00:00.000Z"
}
```

### 4. 测试UID分配
重新创建用户，观察云函数日志：
```
开始获取UID...
查询计数器结果: {...}
计数器存在，当前count: 0
分配新UID: 1
```

## 🎯 预期结果
- 第一个用户: UID = 1
- 第二个用户: UID = 2
- 计数器正常递增

## 🔍 调试技巧
1. 查看云函数实时日志
2. 确认数据库访问权限
3. 检查集合名拼写是否正确
4. 验证文档ID是否为字符串 `"user_counter"`
