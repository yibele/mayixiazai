

# 用户使用顺序：
分为两种。
第一种是用户没有登录，这种情况下。
1、此时显示的用户是普通用户。然后给用户一个 UID 保存在数据库内。
2、当用户开始使用的时候，比如下载视频源文件的时候，开始解析是可以直接使用的。
3、但是在下载视频的时候，就需要观看视频广告。
4、视频广告观看完成之后，就可以直接将视频保存在手机的相册里面。
5、复制视频链接等等内容不需要观看广告。
6、在未登录的情况下，每天只能免费使用 5次，超过 5 次之后，需要进行登录。
7、登录之后，就送 100 积分。

第二种，用户前往我的里面登录。
1、登录之后就有 100 积分。
2、做任务获取积分。

## 开发进度记录

### ✅ 已完成
- [x] 用户系统云函数基础架构
- [x] 数据库表结构设计
- [x] 用户管理器基础框架

### 🚧 正在开发
- [x] **静默登录功能** ✅ 已完成
  - [x] 修改云函数支持静默登录
  - [x] 生成匿名用户UID（设备ID）
  - [x] 实现每日免费次数限制
  - [x] 集成到现有功能
- [x] **集成到文案提取功能** ✅ 已完成
  - [x] 修改文案提取页面使用新的用户系统
  - [x] 添加用户状态显示
  - [x] 集成到视频解析功能
  - [x] 实现权限检查流程
  - [x] 修复TypeScript类型错误

### 📋 待开发
- [ ] 下载时观看广告功能
- [ ] 用户中心页面
- [ ] 正式登录流程
- [ ] 积分任务系统

### 🆔 UID自增机制设计

#### **数据库集合**

**uid_counter集合**
- 文档ID: `user_counter` (固定)
- count: 当前UID计数值
- createTime: 创建时间
- updateTime: 更新时间

**users集合新增字段**
- uid: number - 用户唯一自增ID
- nickName: 默认为 `游客{uid}` 或 `用户{uid}`

#### **UID分配流程**
1. 创建新用户时调用 `getNextUID()` 函数
2. 查询 `uid_counter` 集合的 `user_counter` 文档
3. 如果不存在则创建，count从1开始
4. 如果存在则使用 `_.inc(1)` 原子操作递增
5. 返回递增后的值作为新用户的UID

#### **特点**
- ✅ 从1开始自增
- ✅ 原子操作保证唯一性
- ✅ 容错机制(时间戳备用)
- ✅ 用户昵称更友好
